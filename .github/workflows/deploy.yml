name: Build and Deploy to Laptop Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows, x64]
    
    defaults:
      run:
        shell: powershell
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify .NET Installation
        shell: powershell
        run: |
          Write-Host "Checking .NET installation..." -ForegroundColor Yellow
          try {
            $dotnetVersion = dotnet --version
            Write-Host "✅ .NET version: $dotnetVersion" -ForegroundColor Green
            
            $sdks = dotnet --list-sdks
            Write-Host "`nInstalled SDKs:" -ForegroundColor Cyan
            Write-Host $sdks
            
            if ($sdks -match "10\.0") {
              Write-Host "`n✅ .NET 10 SDK found" -ForegroundColor Green
            } elseif ($sdks -match "9\.0") {
              Write-Host "`n⚠️ Using .NET 9 SDK (NET 10 not found)" -ForegroundColor Yellow
            } elseif ($sdks -match "8\.0") {
              Write-Host "`n⚠️ Using .NET 8 SDK (NET 10 not found)" -ForegroundColor Yellow
            } else {
              Write-Host "`n❌ No compatible .NET SDK found!" -ForegroundColor Red
              exit 1
            }
          } catch {
            Write-Host "❌ .NET is not installed or not in PATH!" -ForegroundColor Red
            exit 1
          }
      
      - name: Restore dependencies
        shell: powershell
        run: dotnet restore
      
      - name: Build
        shell: powershell
        run: dotnet build --configuration Release --no-restore
      
      - name: Run tests (if any)
        shell: powershell
        run: dotnet test --configuration Release --no-build --verbosity normal
        continue-on-error: true
      
      - name: Publish
        shell: powershell
        run: dotnet publish -c Release -o ./publish --self-contained false
      
      - name: Create secure directories on D drive
        shell: powershell
        run: |
          Write-Host "Creating directories on D: drive..." -ForegroundColor Yellow
          New-Item -ItemType Directory -Path "D:\YTdownloadBackend" -Force | Out-Null
          New-Item -ItemType Directory -Path "D:\YTdownloadBackend\logs" -Force | Out-Null
          
          Write-Host "Setting restrictive permissions..." -ForegroundColor Yellow
          try {
            $acl = Get-Acl "D:\YTdownloadBackend"
            $acl.SetAccessRuleProtection($true, $false)
            
            $acl.Access | ForEach-Object { $acl.RemoveAccessRule($_) | Out-Null }
            
            $systemRule = New-Object System.Security.AccessControl.FileSystemAccessRule(
              "SYSTEM", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow"
            )
            $acl.AddAccessRule($systemRule)
            
            $adminRule = New-Object System.Security.AccessControl.FileSystemAccessRule(
              "Administrators", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow"
            )
            $acl.AddAccessRule($adminRule)
            
            Set-Acl "D:\YTdownloadBackend" $acl
            Write-Host "✅ Secure directories created with restricted permissions" -ForegroundColor Green
          } catch {
            Write-Host "⚠️ Could not set restrictive permissions (non-fatal)" -ForegroundColor Yellow
            Write-Host "✅ Directories created" -ForegroundColor Green
          }
          
          # Verify directories were created
          Write-Host "`nVerifying directories:" -ForegroundColor Cyan
          Write-Host "  • App dir: $(Test-Path 'D:\YTdownloadBackend')" -ForegroundColor White
          Write-Host "  • Logs dir: $(Test-Path 'D:\YTdownloadBackend\logs')" -ForegroundColor White
      
      - name: Stop existing service (if running)
        shell: powershell
        run: |
          $service = Get-Service -Name "YTdownloadBackend" -ErrorAction SilentlyContinue
          if ($service) {
            Write-Host "Stopping service..." -ForegroundColor Yellow
            Stop-Service -Name "YTdownloadBackend" -Force
            
            Write-Host "Waiting for service to fully stop..." -ForegroundColor Yellow
            $maxWait = 30
            $waited = 0
            while ($waited -lt $maxWait) {
              $svcStatus = (Get-Service -Name "YTdownloadBackend").Status
              if ($svcStatus -eq "Stopped") {
                Write-Host "✅ Service stopped successfully" -ForegroundColor Green
                break
              }
              Start-Sleep -Seconds 1
              $waited++
              Write-Host "Waiting... ($waited/$maxWait seconds)" -ForegroundColor Gray
            }
            
            # Kill any lingering processes
            Write-Host "Checking for lingering processes..." -ForegroundColor Yellow
            $processes = Get-Process | Where-Object {$_.ProcessName -like "*YTdownload*"}
            if ($processes) {
              Write-Host "Found $($processes.Count) lingering process(es), terminating..." -ForegroundColor Yellow
              $processes | Stop-Process -Force -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 2
            }
            
            # Verify port 5000 is free
            Write-Host "Checking if port 5000 is free..." -ForegroundColor Yellow
            $portInUse = Get-NetTCPConnection -LocalPort 5000 -State Listen -ErrorAction SilentlyContinue
            if ($portInUse) {
              Write-Host "⚠️ Port 5000 is still in use by PID: $($portInUse.OwningProcess)" -ForegroundColor Yellow
              $blockingProcess = Get-Process -Id $portInUse.OwningProcess -ErrorAction SilentlyContinue
              if ($blockingProcess) {
                Write-Host "Killing process: $($blockingProcess.ProcessName) (PID: $($blockingProcess.Id))" -ForegroundColor Yellow
                Stop-Process -Id $blockingProcess.Id -Force
                Start-Sleep -Seconds 3
              }
            } else {
              Write-Host "✅ Port 5000 is free" -ForegroundColor Green
            }
          } else {
            Write-Host "Service not found, skipping stop step" -ForegroundColor Gray
          }
      
      - name: Deploy files to D drive
        shell: powershell
        run: |
          $publishPath = ".\publish"
          $deployPath = "D:\YTdownloadBackend"
          
          Write-Host "Deploying to $deployPath..." -ForegroundColor Yellow
          
          $prodSettings = "$deployPath\appsettings.Production.json"
          $backupSettings = "$deployPath\appsettings.Production.json.backup"
          if (Test-Path $prodSettings) {
            Write-Host "Backing up production settings..." -ForegroundColor Cyan
            Copy-Item -Path $prodSettings -Destination $backupSettings -Force
          }
          
          Copy-Item -Path "$publishPath\*" -Destination $deployPath -Recurse -Force
          
          if (Test-Path $backupSettings) {
            Write-Host "Restoring production settings..." -ForegroundColor Cyan
            Copy-Item -Path $backupSettings -Destination $prodSettings -Force
            Remove-Item $backupSettings -Force
          }
          
          Write-Host "✅ Files deployed successfully" -ForegroundColor Green
          
          Write-Host "`nDeployed files:" -ForegroundColor Cyan
          Get-ChildItem -Path $deployPath -File | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
      
      - name: Install or Verify Windows Service with NSSM
        shell: powershell
        timeout-minutes: 2
        run: |
          $serviceName = "YTdownloadBackend"
          $serviceExe = "D:\YTdownloadBackend\YTdownloadBackend.exe"
          $nssmExe = "D:\nssm\nssm.exe"
          
          # Check if service already exists
          Write-Host "Checking for existing service..." -ForegroundColor Yellow
          $serviceExists = Get-Service -Name $serviceName -ErrorAction SilentlyContinue
          
          if ($serviceExists) {
            Write-Host "✅ Service already exists (Status: $($serviceExists.Status))" -ForegroundColor Green
            Write-Host "Skipping installation..." -ForegroundColor Gray
          } else {
            Write-Host "⚠️ Service does not exist, creating with NSSM..." -ForegroundColor Yellow
            
            # Verify NSSM exists
            if (!(Test-Path $nssmExe)) {
              Write-Host "❌ NSSM not found at: $nssmExe" -ForegroundColor Red
              Write-Host "Please install NSSM manually to D:\nssm\nssm.exe" -ForegroundColor Yellow
              exit 1
            }
            
            # Verify exe exists
            if (!(Test-Path $serviceExe)) {
              Write-Host "❌ Executable not found: $serviceExe" -ForegroundColor Red
              exit 1
            }
            
            Write-Host "✅ NSSM found, installing service..." -ForegroundColor Green
            
            # Install service with NSSM (direct call, no background job)
            & $nssmExe install $serviceName $serviceExe
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host "✅ Service installed successfully" -ForegroundColor Green
              
              # Configure NSSM settings
              Write-Host "Configuring NSSM..." -ForegroundColor Cyan
              
              # Working directory
              & $nssmExe set $serviceName AppDirectory "D:\YTdownloadBackend"
              
              # Environment
              & $nssmExe set $serviceName AppEnvironmentExtra "ASPNETCORE_ENVIRONMENT=Production"
              
              # Logging
              & $nssmExe set $serviceName AppStdout "D:\YTdownloadBackend\logs\stdout.log"
              & $nssmExe set $serviceName AppStderr "D:\YTdownloadBackend\logs\stderr.log"
              
              # Log rotation (10MB or 24 hours)
              & $nssmExe set $serviceName AppRotateFiles 1
              & $nssmExe set $serviceName AppRotateOnline 1
              & $nssmExe set $serviceName AppRotateSeconds 86400
              & $nssmExe set $serviceName AppRotateBytes 10485760
              
              # Auto-restart on failure
              & $nssmExe set $serviceName AppExit Default Restart
              & $nssmExe set $serviceName AppRestartDelay 5000
              
              # Throttle restart attempts
              & $nssmExe set $serviceName AppThrottle 10000
              
              Write-Host "✅ NSSM configuration complete" -ForegroundColor Green
              Write-Host "`nService Configuration:" -ForegroundColor Cyan
              Write-Host "  • Executable: D:\YTdownloadBackend\YTdownloadBackend.exe" -ForegroundColor White
              Write-Host "  • Working Directory: D:\YTdownloadBackend" -ForegroundColor White
              Write-Host "  • Environment: Production" -ForegroundColor White
              Write-Host "  • Logs: D:\YTdownloadBackend\logs\" -ForegroundColor White
              Write-Host "  • Auto-restart: Enabled (5s delay, 10s throttle)" -ForegroundColor White
              Write-Host "  • Log rotation: 10MB or 24 hours" -ForegroundColor White
            } else {
              Write-Host "❌ Failed to install service!" -ForegroundColor Red
              Write-Host "NSSM Exit Code: $LASTEXITCODE" -ForegroundColor Red
              Write-Host "`nTroubleshooting:" -ForegroundColor Yellow
              Write-Host "  1. Ensure GitHub Actions runner runs as LocalSystem" -ForegroundColor White
              Write-Host "  2. Verify NSSM is at D:\nssm\nssm.exe" -ForegroundColor White
              Write-Host "  3. Check Windows Event Viewer for errors" -ForegroundColor White
              exit 1
            }
          }
      
      - name: Start service
        shell: powershell
        run: |
          Write-Host "Starting service..." -ForegroundColor Yellow
          
          # Verify NSSM logging configuration before starting
          Write-Host "`nVerifying NSSM logging configuration:" -ForegroundColor Cyan
          $stdout = & D:\nssm\nssm.exe get YTdownloadBackend AppStdout
          $stderr = & D:\nssm\nssm.exe get YTdownloadBackend AppStderr
          Write-Host "  • STDOUT: $stdout" -ForegroundColor White
          Write-Host "  • STDERR: $stderr" -ForegroundColor White
          
          # Check if Firebase key exists
          $firebaseKey = "D:\YTdownloadBackend\Keys\ytdownloder-7aa70-firebase-adminsdk-fbsvc-565e663998.json"
          if (Test-Path $firebaseKey) {
            Write-Host "  • Firebase key: EXISTS" -ForegroundColor Green
          } else {
            Write-Host "  • Firebase key: MISSING" -ForegroundColor Red
          }
          
          Start-Service -Name "YTdownloadBackend"
          Start-Sleep -Seconds 5
          
          $service = Get-Service -Name "YTdownloadBackend"
          Write-Host "`n✅ Service status: $($service.Status)" -ForegroundColor Green
          
          if ($service.Status -ne 'Running') {
            Write-Host "❌ Service failed to start!" -ForegroundColor Red
            
            # Check if log files exist
            Write-Host "`nChecking for log files:" -ForegroundColor Yellow
            if (Test-Path "D:\YTdownloadBackend\logs\stderr.log") {
              Write-Host "✅ stderr.log exists" -ForegroundColor Green
              Write-Host "`n--- Last 50 lines of Error Log ---" -ForegroundColor Red
              Get-Content "D:\YTdownloadBackend\logs\stderr.log" -Tail 50
            } else {
              Write-Host "❌ stderr.log does NOT exist!" -ForegroundColor Red
            }
            
            if (Test-Path "D:\YTdownloadBackend\logs\stdout.log") {
              Write-Host "✅ stdout.log exists" -ForegroundColor Green
              Write-Host "`n--- Last 50 lines of Output Log ---" -ForegroundColor Cyan
              Get-Content "D:\YTdownloadBackend\logs\stdout.log" -Tail 50
            } else {
              Write-Host "❌ stdout.log does NOT exist!" -ForegroundColor Red
            }
            
            # Try to get process info
            Write-Host "`nChecking for YTdownloadBackend processes:" -ForegroundColor Yellow
            $proc = Get-Process | Where-Object {$_.ProcessName -like "*YTdownload*"}
            if ($proc) {
              Write-Host "⚠️ Process found but service not running:" -ForegroundColor Yellow
              $proc | Format-Table ProcessName, Id, CPU, WorkingSet
            } else {
              Write-Host "❌ No YTdownloadBackend process found" -ForegroundColor Red
            }
            
            exit 1
          }
      
      - name: Verify deployment
        shell: powershell
        run: |
          Write-Host "Verifying deployment..." -ForegroundColor Yellow
          $maxAttempts = 20
          $attempt = 0
          $success = $false
          
          while ($attempt -lt $maxAttempts) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:5000/health" -ErrorAction Stop -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "✅ Service is healthy and responding!" -ForegroundColor Green
                Write-Host "Response: $($response.Content)" -ForegroundColor Cyan
                $success = $true
                break
              }
            } catch {
              Write-Host "Attempt $($attempt + 1)/$maxAttempts - Waiting for service..." -ForegroundColor Gray
              Start-Sleep -Seconds 3
            }
            $attempt++
          }
          
          if (!$success) {
            Write-Host "❌ Service verification failed after $maxAttempts attempts" -ForegroundColor Red
            Write-Host "`nChecking service logs..." -ForegroundColor Yellow
            
            if (Test-Path "D:\YTdownloadBackend\logs\stderr.log") {
              Write-Host "`n--- Last 30 lines of Error Log ---" -ForegroundColor Red
              Get-Content "D:\YTdownloadBackend\logs\stderr.log" -Tail 30
            }
            
            if (Test-Path "D:\YTdownloadBackend\logs\stdout.log") {
              Write-Host "`n--- Last 30 lines of Output Log ---" -ForegroundColor Cyan
              Get-Content "D:\YTdownloadBackend\logs\stdout.log" -Tail 30
            }
            
            Write-Host "`n--- Checking Windows Event Log ---" -ForegroundColor Yellow
            Get-EventLog -LogName Application -Newest 5 -ErrorAction SilentlyContinue | Where-Object {$_.Source -like "*YT*" -or $_.Source -like "*.NET*"} | Format-List TimeGenerated, Source, Message
            
            exit 1
          }
      
      - name: Security Check
        shell: powershell
        run: |
          Write-Host "`nRunning security checks..." -ForegroundColor Yellow
          
          $service = Get-WmiObject Win32_Service | Where-Object {$_.Name -eq "YTdownloadBackend"}
          Write-Host "Service runs as: $($service.StartName)" -ForegroundColor Cyan
          
          $acl = Get-Acl "D:\YTdownloadBackend"
          Write-Host "`nDirectory Permissions:" -ForegroundColor Cyan
          $acl.Access | Select-Object IdentityReference, FileSystemRights, AccessControlType | Format-Table -AutoSize
          
          Write-Host "✅ Security check complete" -ForegroundColor Green
      
      - name: Deployment Summary
        shell: powershell
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "   ✅ DEPLOYMENT SUCCESSFUL" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Service Name: YTdownloadBackend" -ForegroundColor White
          Write-Host "Status: Running" -ForegroundColor Green
          Write-Host "Environment: Production" -ForegroundColor Yellow
          Write-Host "Location: D:\YTdownloadBackend" -ForegroundColor White
          Write-Host "Local URL: http://localhost:5000" -ForegroundColor White
          Write-Host "Health Check: http://localhost:5000/health" -ForegroundColor White
          Write-Host "Logs: D:\YTdownloadBackend\logs\" -ForegroundColor White
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "⚠️  SECURITY REMINDERS:" -ForegroundColor Yellow
          Write-Host "  1. Configure Cloudflare Tunnel for HTTPS" -ForegroundColor White
          Write-Host "  2. Enable JWT authentication" -ForegroundColor White
          Write-Host "  3. Set up rate limiting" -ForegroundColor White
          Write-Host "  4. Use environment variables for secrets" -ForegroundColor White
          Write-Host "  5. Configure Windows Firewall" -ForegroundColor White
          Write-Host "========================================`n" -ForegroundColor Cyan